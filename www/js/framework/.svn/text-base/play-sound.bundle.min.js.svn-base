
(function (doc, cssText) {
    var styleEl = doc.createElement("style");
    doc.getElementsByTagName("head")[0].appendChild(styleEl);
    if (styleEl.styleSheet) {
        if (!styleEl.styleSheet.disabled) {
            styleEl.styleSheet.cssText = cssText;
        }
    } else {
        try {
            styleEl.innerHTML = cssText;
        } catch (ignore) {
            styleEl.innerText = cssText;
        }
    }
}(document, ".play-sound {\n" +
    "    padding-top: 5px;\n" +
    "    padding-bottom: 5px;\n" +
    "}\n" +
    "\n" +
    ".play-sound svg {\n" +
    "    margin-bottom: -3px\n" +
    "}\n" +
    "\n" +
    ".play-sound :first-child {\n" +
    "    min-width: 50px;\n" +
    "    max-width: 180px;\n" +
    "    text-align: left;\n" +
    "    ;\n" +  //box-shadow: 1px 1px 1px #dddddd
    "}\n" +
    "\n" +
    ".play-sound i {\n" +
    "    box-shadow: none !important;\n" +
    "}\n" +
    "\n" +
    ".play-sound i::before {\n" +
    "    transform: rotate(45deg);\n" +
    "    color: #808080;\n" +
    "}\n" +
    "\n" +
    ".play-sound span {\n" +
    "    font-size: 8px;\n" +
    "    color: #9D9D9B;\n" +
    "    vertical-align: -webkit-baseline-middle;\n" +
    "}\n" +
    "\n" +
    ".play-sound .refresh {\n" +
    "    padding: 3px;\n" +
    "    color: #d50000;\n" +
    "    font-size: 20px;\n" +
    "}\n" +
    "\n" +
    ".play-sound .new {\n" +
    "    color: #d50000;\n" +
    "}\n" +
    "\n" +
    ".play-sound-right {\n" +
    "    transform: rotate(180deg);\n" +
    "}\n" +
    "\n" +
    ".play-sound-right :first-child {\n" +
    "    background-color: #FFFFFF !important;\n" +
    "}\n" +
    "\n" +
    ".play-sound-right span {\n" +
    "    display: inline-block;\n" +
    "    transform: rotate(180deg) !important;\n" +
    "}\n" +
    "\n" +
    ".play-sound-right div i::before {\n" +
    "    color: #DDDDDD !important;\n" +
    "}"));

(function(module) {
    try {
        module = angular.module('play-sound.templates');
    } catch (e) {
        module = angular.module('play-sound.templates', []);
    }
    module.run(['$templateCache', function($templateCache) {
        $templateCache.put('play-sound.html',
            '<div class="play-sound">\n' +
            '    <div class="button padding-horizontal" style="padding: 0;padding-left: 8px;" ng-disabled="isLoading" ng-click="play()">\n' +
            '        <img class="" src="http://cdn09.ehaier.com/shunguang/H5/www/img/quanzi/playaudio.png" ng-show="!isLoading" />\n' +
            '        <svg width=\'15px\' height=\'15px\' xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" ng-show="isLoading"\n' +
            '             preserveAspectRatio="xMidYMid" class="uil-spin" style="    position: relative;bottom: 12px;">\n' +
            '            <rect x="0" y="0" width="100" height="100" fill="none" class="bk"></rect>\n' +
            '            <g transform="translate(50 50)">\n' +
            '                <g transform="rotate(0) translate(34 0)">\n' +
            '                    <circle cx="0" cy="0" r="8" fill="#555">\n' +
            '                        <animate attributeName="opacity" from="1" to="0.1" begin="0s" dur="1s"\n' +
            '                                 repeatCount="indefinite"></animate>\n' +
            '                        <animateTransform attributeName="transform" type="scale" from="1.1" to="1" begin="0s" dur="1s"\n' +
            '                                          repeatCount="indefinite"></animateTransform>\n' +
            '                    </circle>\n' +
            '                </g>\n' +
            '                <g transform="rotate(45) translate(34 0)">\n' +
            '                    <circle cx="0" cy="0" r="8" fill="#555">\n' +
            '                        <animate attributeName="opacity" from="1" to="0.1" begin="0.12s" dur="1s"\n' +
            '                                 repeatCount="indefinite"></animate>\n' +
            '                        <animateTransform attributeName="transform" type="scale" from="1.1" to="1" begin="0.12s"\n' +
            '                                          dur="1s" repeatCount="indefinite"></animateTransform>\n' +
            '                    </circle>\n' +
            '                </g>\n' +
            '                <g transform="rotate(90) translate(34 0)">\n' +
            '                    <circle cx="0" cy="0" r="8" fill="#555">\n' +
            '                        <animate attributeName="opacity" from="1" to="0.1" begin="0.25s" dur="1s"\n' +
            '                                 repeatCount="indefinite"></animate>\n' +
            '                        <animateTransform attributeName="transform" type="scale" from="1.1" to="1" begin="0.25s"\n' +
            '                                          dur="1s" repeatCount="indefinite"></animateTransform>\n' +
            '                    </circle>\n' +
            '                </g>\n' +
            '                <g transform="rotate(135) translate(34 0)">\n' +
            '                    <circle cx="0" cy="0" r="8" fill="#555">\n' +
            '                        <animate attributeName="opacity" from="1" to="0.1" begin="0.37s" dur="1s"\n' +
            '                                 repeatCount="indefinite"></animate>\n' +
            '                        <animateTransform attributeName="transform" type="scale" from="1.1" to="1" begin="0.37s"\n' +
            '                                          dur="1s" repeatCount="indefinite"></animateTransform>\n' +
            '                    </circle>\n' +
            '                </g>\n' +
            '                <g transform="rotate(180) translate(34 0)">\n' +
            '                    <circle cx="0" cy="0" r="8" fill="#555">\n' +
            '                        <animate attributeName="opacity" from="1" to="0.1" begin="0.5s" dur="1s"\n' +
            '                                 repeatCount="indefinite"></animate>\n' +
            '                        <animateTransform attributeName="transform" type="scale" from="1.1" to="1" begin="0.5s" dur="1s"\n' +
            '                                          repeatCount="indefinite"></animateTransform>\n' +
            '                    </circle>\n' +
            '                </g>\n' +
            '                <g transform="rotate(225) translate(34 0)">\n' +
            '                    <circle cx="0" cy="0" r="8" fill="#555">\n' +
            '                        <animate attributeName="opacity" from="1" to="0.1" begin="0.62s" dur="1s"\n' +
            '                                 repeatCount="indefinite"></animate>\n' +
            '                        <animateTransform attributeName="transform" type="scale" from="1.1" to="1" begin="0.62s"\n' +
            '                                          dur="1s" repeatCount="indefinite"></animateTransform>\n' +
            '                    </circle>\n' +
            '                </g>\n' +
            '                <g transform="rotate(270) translate(34 0)">\n' +
            '                    <circle cx="0" cy="0" r="8" fill="#555">\n' +
            '                        <animate attributeName="opacity" from="1" to="0.1" begin="0.75s" dur="1s"\n' +
            '                                 repeatCount="indefinite"></animate>\n' +
            '                        <animateTransform attributeName="transform" type="scale" from="1.1" to="1" begin="0.75s"\n' +
            '                                          dur="1s" repeatCount="indefinite"></animateTransform>\n' +
            '                    </circle>\n' +
            '                </g>\n' +
            '                <g transform="rotate(315) translate(34 0)">\n' +
            '                    <circle cx="0" cy="0" r="8" fill="#555">\n' +
            '                        <animate attributeName="opacity" from="1" to="0.1" begin="0.87s" dur="1s"\n' +
            '                                 repeatCount="indefinite"></animate>\n' +
            '                        <animateTransform attributeName="transform" type="scale" from="1.1" to="1" begin="0.87s"\n' +
            '                                          dur="1s" repeatCount="indefinite"></animateTransform>\n' +
            '                    </circle>\n' +
            '                </g>\n' +
            '            </g>\n' +
            '        </svg>\n' +
            '    </div>\n' +
            '    <span ng-bind="dur|DurFilter" ng-if="!isLoading&&!isError"></span>\n' +
            '    <span class="icon ion-ios-refresh refresh" ng-if="isError" ng-click="reload()"></span>\n' +
            '    <span class="icon ion-record new" ng-if="isNew && !isLoading&&!isError"></span>\n' +
            '    <audio preload="auto">\n' +
            '        <source ng-src="{{url|Trusted}}" type="audio/wav">\n' +
            '    </audio>\n' +
            '    <loading ng-include=""></loading>\n' +
            '</div>\n' +
            '');
    }]);
})();

/**
 * Created by Lossa on 2017/1/4.
 * 使用方法：
 * <play-sound url="http://www.example.com/url/sound/test.ogg" side="right"></play-sound>
 * url指向资源的url，side可选项
 */
angular.module('play-sound.directive', [])
    .directive('playSound', ['$state', '$timeout', '$interval','$rootScope',
        function ($state, $timeout, $interval,$rootScope) {
            return {
                restrict: 'E',
                replace: true,
                scope: {
                    url: '@url',//必填
                    side: '@side',// 左边还是右边
                    isNew: '@isNew',// 红点显示
                },
                templateUrl: 'play-sound.html',
                link: function (scope, element, attr, controller) {
                    if (scope.side == 'right') {
                        element[0].className = 'play-sound play-sound-right'
                    }
                    var ctrl = $rootScope.chatScope.targetScope;//controller.为了协同其他audio工作，需要传递指令指令之间通信
                      //by xuf 将ctrl 设为 指令所在 的 父scope 保存在 rootscope 中，协调各指令 动作，在进入 该页面时 初始化，不需要 通过监听 parentView 的事件了
                    scope.isLoading = true;//loading 标志位
                    scope.isError = false;//isError 标志位
                    var audio = element[0].getElementsByTagName('audio')[0];
                    var source = element[0].getElementsByTagName('source')[0];
                    var btn = element[0].getElementsByClassName('button')[0];
                    var stopInterval = undefined;
                    audio.addEventListener('loadedmetadata', function (e) {
                        scope.dur = audio.duration;
                        scope.isLoading = false;
                        scope.isError = false;
                        btn.style.width = parseInt(50 + (180 - 50) / 20 * scope.dur) + 'px';

                        console.log('loadedmetadata------!!!!!');
                    }, false);
                    audio.addEventListener('canplaythrough', function (e) {
                        scope.dur = audio.duration;
                        scope.isLoading = false;
                        scope.isError = false;
                        btn.style.width = parseInt(50 + (180 - 50) / 20 * scope.dur) + 'px';

                        console.log('canplaythrough------!!!!!');
                    }, false);

                    audio.addEventListener('ended', function () {
                        audio.pause();
                        audio.currentTime = 0;
                    }, false);

                    audio.addEventListener('error', function () {
                        scope.isError = true;
                    }, false);
                    //播放下一条代码
                    //scope.$on('play-sound-next', function (e, v) {
                    //    if(v.id === source.src){
                    //        $timeout(function(){
                    //            scope.isNew = false;
                    //        })
                    //        audio.play();
                    //    }
                    //});
                    //
                    //
                    //audio.addEventListener('ended', function () {
                    //    $rootScope.$broadcast('play-sound-ended',{id:source})
                    //
                    //}, false);

                    ctrl.$on('play-sound:stop', function (e, v) {
                        if (v.who.$id != scope.$id) {
                            audio.pause();
                            audio.currentTime = 0;
                        }
                    });


                    scope.$on('$ionicParentView.beforeLeave', function (e, v) {
                        audio.pause();
                    });


                    scope.play = function () {
                        ctrl.$broadcast('play-sound:stop', {who: scope});
                        if (!audio.currentTime) {
                            audio.volume =1;
                            scope.isNew = false;
                            audio.pause();
                            audio.currentTime = 0;
                            audio.play();

                            ///**针对小米手机不preload的问题，采取的修正折中**/
                            //stopInterval = $interval(function () {
                            //    console.log('interval doing:', audio.duration);
                            //    if (scope.dur != audio.duration && audio.duration > 0) {
                            //        scope.dur = audio.duration;
                            //        scope.isLoading = false;
                            //        scope.isError = false;
                            //        btn.style.width = parseInt(50 + (180 - 50) / 20 * scope.dur) + 'px';
                            //    }
                            //}, 500);
                            //$timeout(function () {
                            //    $interval.cancel(stopInterval);
                            //}, 6000);

                        } else {
                            audio.pause();
                            audio.currentTime = 0;
                        }
                    };

                    scope.reload = function () {
                        audio.load();
                        scope.isLoading = true;
                    };
                }
            }
        }]);

angular.module('play-sound.filter', [])
    .filter('DurFilter', [function () {
        return function (time) {
            if (time) {
                if (isNaN(time)) {
                    time = '?';
                }
                return Math.round(time) + '\"';
            }
        };
    }])
    .filter('Trusted', ['$sce', function ($sce) {
        return function (url) {
            return $sce.trustAsResourceUrl(url);
        };
    }]);
;
/**
 * Created by Lossa on 2017/1/4.
 */
angular.module('play-sound', [
    'ionic',
    'play-sound.filter',
    'play-sound.directive',
    'play-sound.templates',
]);